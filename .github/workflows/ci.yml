name: CI

on:
  push:
    branches: [main, master]
  pull_request:

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  validate-manifests:
    runs-on: ubuntu-latest
    needs: [secret-scan]
    steps:
      - uses: actions/checkout@v4
      - name: Install ripgrep
        run: apt-get update && apt-get install -y ripgrep
      - name: Check public/internal boundary
        run: bash scripts/check_public_boundary.sh
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install validation dependencies
        run: |
          pip install pyyaml
          # Needed to import bsim entrypoints referenced by curated model manifests.
          pip install "bsim @ git+https://github.com/BioSimulant/bsim.git@main"
      - name: Validate manifest schema
        run: python scripts/validate_manifests.py
      - name: Check entrypoints
        run: python scripts/check_entrypoints.py

  smoke-sandbox:
    runs-on: ubuntu-latest
    needs: [validate-manifests]
    container:
      image: python:3.11-slim
    steps:
      - uses: actions/checkout@v4
      - name: Install validation dependencies
        run: |
          pip install pyyaml
          pip install "bsim @ git+https://github.com/BioSimulant/bsim.git@main"
      - name: Smoke run checks (sandbox-compatible image)
        run: |
          python scripts/validate_manifests.py
          python scripts/check_entrypoints.py
